<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>earthtown - admin panel</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Inter:wght@300;400;500;600&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            color: #f1faee;
            min-height: 100vh;
        }

        .header {
            padding: 20px 40px;
            background: rgba(241, 250, 238, 0.02);
            border-bottom: 1px solid rgba(241, 250, 238, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-family: 'VT323', monospace;
            font-size: 2.5rem;
            letter-spacing: 2px;
            color: #e63946;
        }

        .back-btn {
            font-family: 'VT323', monospace;
            font-size: 1.3rem;
            color: #f1faee;
            text-decoration: none;
            padding: 8px 20px;
            border: 1px solid rgba(241, 250, 238, 0.2);
            border-radius: 6px;
            transition: all 0.3s;
            letter-spacing: 1px;
        }

        .back-btn:hover { background: rgba(241, 250, 238, 0.05); }

        .main-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 40px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(241, 250, 238, 0.03);
            border: 1px solid rgba(241, 250, 238, 0.1);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
        }

        .stat-number {
            font-family: 'VT323', monospace;
            font-size: 3rem;
            color: #f77f00;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #888;
        }

        .tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(241, 250, 238, 0.1);
        }

        .tab {
            font-family: 'VT323', monospace;
            font-size: 1.5rem;
            padding: 12px 24px;
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            letter-spacing: 1px;
        }

        .tab.active {
            color: #f1faee;
            border-bottom: 2px solid #f77f00;
        }

        .review-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }

        .review-item {
            background: rgba(241, 250, 238, 0.03);
            border: 1px solid rgba(241, 250, 238, 0.15);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .review-item:hover {
            border-color: rgba(247, 127, 0, 0.5);
            transform: translateY(-5px);
        }

        .review-preview {
            width: 100%;
            aspect-ratio: 16/9;
            background: rgba(241, 250, 238, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            overflow: hidden;
        }

        .review-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .review-info {
            padding: 20px;
        }

        .review-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .review-meta {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 10px;
        }

        .review-description {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .review-actions {
            display: flex;
            gap: 10px;
        }

        .review-btn {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
            letter-spacing: 1px;
        }

        .btn-approve {
            background: rgba(45, 106, 79, 0.2);
            color: #2d6a4f;
            border: 1px solid #2d6a4f;
        }

        .btn-approve:hover {
            background: rgba(45, 106, 79, 0.4);
        }

        .btn-reject {
            background: rgba(230, 57, 70, 0.2);
            color: #e63946;
            border: 1px solid #e63946;
        }

        .btn-reject:hover {
            background: rgba(230, 57, 70, 0.4);
        }

        .empty-state {
            text-align: center;
            padding: 100px 20px;
            color: #666;
        }

        .empty-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }

        .empty-text {
            font-family: 'VT323', monospace;
            font-size: 2rem;
            letter-spacing: 2px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="page-title">üõ°Ô∏è admin panel</h1>
        <a href="hub.html" class="back-btn">‚Üê back to hub</a>
    </div>

    <div class="main-content">
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="pendingCount">0</div>
                <div class="stat-label">Pending Approval</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="approvedCount">0</div>
                <div class="stat-label">Approved</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="rejectedCount">0</div>
                <div class="stat-label">Rejected</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">Total Submissions</div>
            </div>
        </div>

        <!-- Storage Cleanup Section -->
        <div class="stats" style="margin-top: 30px;">
            <div class="stat-card" style="flex: 1;">
                <div class="stat-label" style="margin-bottom: 15px;">üóëÔ∏è Storage Cleanup</div>
                <button id="cleanupBtn" onclick="cleanOldUploads()" style="
                    width: 100%;
                    padding: 15px;
                    background: rgba(230, 57, 70, 0.2);
                    border: 2px solid #e63946;
                    border-radius: 8px;
                    color: #e63946;
                    font-family: 'VT323', monospace;
                    font-size: 1.3rem;
                    cursor: pointer;
                    transition: all 0.3s;
                    letter-spacing: 1px;
                ">
                    Clean Old Uploads (24h+)
                </button>
                <div id="cleanupStatus" style="margin-top: 10px; font-size: 0.9rem; color: #888; text-align: center;"></div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-type="music" onclick="switchTab('music')">üéµ music</button>
            <button class="tab" data-type="video" onclick="switchTab('video')">üé¨ video</button>
            <button class="tab" data-type="art" onclick="switchTab('art')">üñºÔ∏è art</button>
        </div>

        <div class="review-grid" id="reviewGrid">
            <!-- Populated by JavaScript -->
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCXFlGeJodOUVn-3bYocPhFRtzs9DBHEFA",
            authDomain: "earthtown-92993.firebaseapp.com",
            projectId: "earthtown-92993",
            storageBucket: "earthtown-92993.firebasestorage.app",
            messagingSenderId: "830730193161",
            appId: "1:830730193161:web:af18953dd80872b1396bd8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let currentUser = null;
        let currentType = 'music';

        const typeIcons = {
            music: 'üéµ',
            video: 'üé¨',
            art: 'üñºÔ∏è'
        };

        // TODO: Add admin user check here
        // For now, any logged in user can access (you should add proper admin role checking)
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadStats();
                await loadPendingReviews(currentType);
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadStats() {
            try {
                const snapshot = await getDocs(collection(db, 'gallery'));
                
                let pending = 0, approved = 0, rejected = 0;
                
                snapshot.forEach(doc => {
                    const status = doc.data().status;
                    if (status === 'pending') pending++;
                    else if (status === 'approved') approved++;
                    else if (status === 'rejected') rejected++;
                });

                document.getElementById('pendingCount').textContent = pending;
                document.getElementById('approvedCount').textContent = approved;
                document.getElementById('rejectedCount').textContent = rejected;
                document.getElementById('totalCount').textContent = snapshot.size;

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        window.switchTab = function(type) {
            currentType = type;
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.type === type);
            });
            loadPendingReviews(type);
        };

        async function loadPendingReviews(type) {
            const grid = document.getElementById('reviewGrid');
            grid.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">Loading...</div>';

            try {
                const pendingQuery = query(
                    collection(db, 'gallery'),
                    where('type', '==', type),
                    where('status', '==', 'pending')
                );

                const snapshot = await getDocs(pendingQuery);
                
                if (snapshot.empty) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">‚úì</div>
                            <div class="empty-text">no pending ${type} to review</div>
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    grid.appendChild(createReviewItem(docSnap.id, data));
                });

            } catch (error) {
                console.error('Error loading reviews:', error);
                grid.innerHTML = '<div style="text-align:center; padding:40px; color:#e63946;">Error loading reviews</div>';
            }
        }

        function createReviewItem(id, data) {
            const item = document.createElement('div');
            item.className = 'review-item';

            const uploadDate = data.uploadedAt ? new Date(data.uploadedAt.seconds * 1000).toLocaleDateString() : 'Unknown date';

            item.innerHTML = `
                <div class="review-preview">
                    ${data.thumbnailUrl ? `<img src="${data.thumbnailUrl}">` : typeIcons[data.type]}
                </div>
                <div class="review-info">
                    <div class="review-title">${data.title || 'Untitled'}</div>
                    <div class="review-meta">by ${data.username} ‚Ä¢ ${uploadDate}</div>
                    ${data.description ? `<div class="review-description">${data.description}</div>` : ''}
                    <div class="review-actions">
                        <button class="review-btn btn-approve" onclick="approveItem('${id}')">‚úì Approve</button>
                        <button class="review-btn btn-reject" onclick="rejectItem('${id}')">‚úó Reject</button>
                    </div>
                </div>
            `;

            return item;
        }

        window.approveItem = async function(itemId) {
            if (!confirm('Approve this submission?')) return;

            try {
                await updateDoc(doc(db, 'gallery', itemId), {
                    status: 'approved',
                    approvedAt: serverTimestamp(),
                    approvedBy: currentUser.uid
                });

                await loadStats();
                await loadPendingReviews(currentType);

            } catch (error) {
                console.error('Error approving:', error);
                alert('Error approving item');
            }
        };

        window.rejectItem = async function(itemId) {
            if (!confirm('Reject this submission? The user will see it as rejected.')) return;

            try {
                await updateDoc(doc(db, 'gallery', itemId), {
                    status: 'rejected',
                    rejectedAt: serverTimestamp(),
                    rejectedBy: currentUser.uid
                });

                await loadStats();
                await loadPendingReviews(currentType);

            } catch (error) {
                console.error('Error rejecting:', error);
                alert('Error rejecting item');
            }
        };

        // Clean old uploads (24h+)
        window.cleanOldUploads = async function() {
            const statusDiv = document.getElementById('cleanupStatus');
            const btn = document.getElementById('cleanupBtn');
            
            try {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                statusDiv.textContent = 'Scanning for old uploads...';
                
                const rooms = ['sanctuary', 'studio', 'gathering', 'supernaturvl'];
                const cutoffTime = new Date(Date.now() - 24 * 60 * 60 * 1000); // 24 hours ago
                let totalFound = 0;
                let totalSize = 0;
                const tracksToDelete = [];
                
                // Scan all rooms
                for (const roomName of rooms) {
                    const queueRef = collection(db, 'rooms', roomName, 'queue');
                    const snapshot = await getDocs(queueRef);
                    
                    snapshot.forEach(doc => {
                        const track = doc.data();
                        // Only delete user uploads (have storagePath and uploadedAt)
                        if (track.storagePath && track.uploadedAt) {
                            const uploadTime = new Date(track.uploadedAt);
                            if (uploadTime < cutoffTime) {
                                tracksToDelete.push({
                                    room: roomName,
                                    docId: doc.id,
                                    storagePath: track.storagePath,
                                    title: track.title
                                });
                                totalFound++;
                            }
                        }
                    });
                }
                
                if (totalFound === 0) {
                    statusDiv.textContent = '‚úì No old uploads found';
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    return;
                }
                
                // Confirm deletion
                const confirmed = confirm(
                    `Found ${totalFound} uploads older than 24 hours.\n\n` +
                    `This will permanently delete:\n` +
                    `‚Ä¢ ${totalFound} tracks from queue\n` +
                    `‚Ä¢ ${totalFound} files from storage\n\n` +
                    `Continue?`
                );
                
                if (!confirmed) {
                    statusDiv.textContent = 'Cleanup cancelled';
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    return;
                }
                
                // Delete tracks
                statusDiv.textContent = `Deleting ${totalFound} tracks...`;
                let deleted = 0;
                
                for (const track of tracksToDelete) {
                    try {
                        // Delete from Firestore
                        await deleteDoc(doc(db, 'rooms', track.room, 'queue', track.docId));
                        
                        // Delete from Storage
                        const storageRef = ref(storage, track.storagePath);
                        await deleteObject(storageRef);
                        
                        deleted++;
                        statusDiv.textContent = `Deleted ${deleted} / ${totalFound}...`;
                    } catch (error) {
                        console.error(`Error deleting ${track.title}:`, error);
                    }
                }
                
                statusDiv.textContent = `‚úì Deleted ${deleted} old uploads`;
                alert(`‚úì Cleanup complete!\n\nDeleted ${deleted} tracks older than 24 hours.`);
                
            } catch (error) {
                console.error('Cleanup error:', error);
                statusDiv.textContent = '‚ùå Cleanup failed';
                alert(`Error during cleanup: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        };
    </script>
</body>
</html>
